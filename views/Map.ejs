<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Map Page</title>
    <script type="text/javascript"
        src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=2j5bpft4t3&submodules=geocoder"></script>
    <link rel="stylesheet" href="/css/Map.css">
    <script src="/js/Map.js" defer></script>
</head>

<body>
    <button class="toggle-button" id="toggleButton" onclick="toggleSidebar()">â˜°</button>

    <div class="sidebar" id="sidebar" style="display: none;">
        <button class="close-button" onclick="toggleSidebar()">Ã—</button>
        <h2>ê¸°ëŠ¥</h2>
        <div id="functionContainer">
            <ul>
                <li onclick="showTravelInfo()">ì—¬í–‰ ì •ë³´ ë“±ë¡</li>
                <li onclick="showUserInfo()">ì‚¬ìš©ì ì •ë³´</li>
            </ul>
        </div>
        <div class="search-container" id="searchContainer" style="display: none;">
            <button onclick="goBack()" style="margin-bottom: 10px;">ë’¤ë¡œê°€ê¸°</button> <!-- ìœ„ì¹˜ ë³€ê²½ -->
            <input type="text" id="searchInput" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”...">
            <button onclick="searchLocations()">ê²€ìƒ‰</button>
            <div id="searchResults" class="results-container"></div>
        </div>
        <button class="logout-button" onclick="logout()" style="margin-top: auto;">ğŸšª ë¡œê·¸ì•„ì›ƒ</button> <!-- ë§¨ ì•„ë˜ë¡œ ì´ë™ -->
    </div>

    <div id="map" style="width:100%;height:100%;"></div>

    <div class="chat-icon" id="chatIcon" onclick="toggleChatBox()">ğŸ’¬</div>

    <div class="chat-box" id="chatBox">
        <div class="chat-box-header">
            Chat
            <button onclick="toggleChatBox()"
                style="background: none; border: none; color: white; font-size: 20px;">Ã—</button>
        </div>
        <div class="chat-box-content" id="chatContent"></div>
        <div class="chat-box-footer">
            <input type="text" id="chatInput" placeholder="Type a message...">
            <button onclick="sendMessage()">Send</button>
        </div>
    </div>

    <script>
        let map;
        let markers = [];

        function initMap() {
            map = new naver.maps.Map('map', {
                center: new naver.maps.LatLng(37.3595704, 127.105399),
                zoom: 10
            });
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const toggleButton = document.getElementById('toggleButton');

            if (sidebar.style.display === "none") {
                sidebar.style.display = "block";
                setTimeout(() => {
                    sidebar.classList.add('active');
                }, 10);
                toggleButton.classList.add('hidden');
            } else {
                sidebar.classList.remove('active');
                setTimeout(() => {
                    sidebar.style.display = "none";
                }, 300);
                toggleButton.classList.remove('hidden');
            }
        }

        function showTravelInfo() {
            // ëª¨ë“  ìš”ì†Œ ë¹„í™œì„±í™”
            document.getElementById('functionContainer').style.display = 'none';
            // ê²€ìƒ‰ ê¸°ëŠ¥ í™œì„±í™”
            document.getElementById('searchContainer').style.display = 'block';
        }

        function showUserInfo() {
            const userInfoBox = document.getElementById('userInfoBox');
            const userInfo = document.getElementById('userInfo');

            // ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸° (ì˜ˆì‹œë¡œ í•˜ë“œì½”ë”©)
            const username = "ì‚¬ìš©ì ì•„ì´ë””"; // ì‹¤ì œ ë°ì´í„°ë¡œ ëŒ€ì²´
            const password = "ë¹„ë°€ë²ˆí˜¸"; // ì‹¤ì œ ë°ì´í„°ë¡œ ëŒ€ì²´

            userInfo.textContent = `ì•„ì´ë””: ${username}, ë¹„ë°€ë²ˆí˜¸: ${password}`;
            userInfoBox.style.display = "block"; // ì‚¬ìš©ì ì •ë³´ ë°•ìŠ¤ ë³´ì´ê¸°
        }

        function goBack() {
            // ê²€ìƒ‰ ê¸°ëŠ¥ ìˆ¨ê¸°ê¸°
            document.getElementById('searchContainer').style.display = 'none';
            // ê¸°ëŠ¥ ì»¨í…Œì´ë„ˆ ë‹¤ì‹œ í™œì„±í™”
            document.getElementById('functionContainer').style.display = 'block';
        }

        function logout() {
            // ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬ (ì˜ˆ: ì„¸ì…˜ ì¢…ë£Œ ë° ì´ˆê¸° í™”ë©´ìœ¼ë¡œ ì´ë™)
            window.location.href = '/'; // ì´ˆê¸° í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ê¸°
        }

        function toggleChatBox() {
            const chatBox = document.getElementById('chatBox');
            const chatIcon = document.getElementById('chatIcon');

            if (chatBox.style.display === "none") {
                chatBox.style.display = "flex";
                chatIcon.style.display = "none";
            } else {
                chatBox.style.display = "none";
                chatIcon.style.display = "flex";
            }
        }

        function sendMessage() {
            const chatInput = document.getElementById('chatInput');
            const chatContent = document.getElementById('chatContent');
            const message = chatInput.value;

            if (message.trim() !== "") {
                const newMessage = document.createElement('div');
                newMessage.textContent = message;
                chatContent.appendChild(newMessage);
                chatInput.value = "";
            }
        }

        async function fetchNaverData(query) {
            console.log(`Searching for: ${query}`); // ìš”ì²­ ì§ì „ ë¡œê·¸ ì¶”ê°€
            try {
                const response = await fetch(`/search?query=${encodeURIComponent(query)}`);
                console.log(`Response status: ${response.status}`); // ì‘ë‹µ ìƒíƒœ ë¡œê·¸
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                console.log('Data received:', data); // ë°˜í™˜ëœ ë°ì´í„° ë¡œê·¸ ì¶œë ¥
                return data;
            } catch (error) {
                console.error("Error fetching data:", error);
            }
        }

        async function searchLocations() {
            const query = document.getElementById('searchInput').value;
            const results = await fetchNaverData(query);

            const resultsContainer = document.getElementById('searchResults');
            resultsContainer.innerHTML = '';

            if (results.items) {
                results.items.forEach(item => {
                    const resultDiv = document.createElement('div');
                    resultDiv.innerHTML = `
                <strong>${item.title}</strong><br>
                <span>${item.description || ''}</span><br>
                <span>${item.address || ''}</span><br>
                <button onclick="goToLocation(${item.mapx}, ${item.mapy})">ìœ„ì¹˜ë¡œ ê°€ê¸°</button>
            `;
                    resultsContainer.appendChild(resultDiv);
                });
            }
        }
        function goToLocation(mapx, mapy) {
            // ë¬¸ìì—´ì„ ìˆ«ìë¡œ ë³€í™˜
            const longitude = parseFloat(mapx) / 10000000; // 10,000,000ìœ¼ë¡œ ë‚˜ëˆ„ê¸°
            const latitude = parseFloat(mapy) / 10000000; // 10,000,000ìœ¼ë¡œ ë‚˜ëˆ„ê¸°

            const location = new naver.maps.LatLng(latitude, longitude); // ìœ„ë„, ê²½ë„ ìˆœì„œ

            // ê¸°ì¡´ ë§ˆì»¤ ì œê±°
            markers.forEach(marker => {
                marker.setMap(null); // ì§€ë„ì—ì„œ ë§ˆì»¤ ì œê±°
            });
            markers = []; // ë§ˆì»¤ ë°°ì—´ ì´ˆê¸°í™”

            // ìƒˆë¡œìš´ ë§ˆì»¤ ì¶”ê°€
            const marker = new naver.maps.Marker({
                position: location,
                map: map,
                title: "ì„ íƒí•œ ìœ„ì¹˜"
            });

            markers.push(marker); // ìƒˆë¡œìš´ ë§ˆì»¤ ë°°ì—´ì— ì¶”ê°€

            // ì§€ë„ ì´ë™
            map.setCenter(location);
            map.setZoom(16); // ì ì ˆí•œ ì¤Œ ë ˆë²¨ë¡œ ì„¤ì •
        }
        function addMarker(item) {
            console.log("Adding marker for item:", item);

            // ë¬¸ìì—´ì„ ìˆ«ìë¡œ ë³€í™˜
            const longitude = parseFloat(item.mapx) / 10000000; // 10,000,000ìœ¼ë¡œ ë‚˜ëˆ„ê¸°
            const latitude = parseFloat(item.mapy) / 10000000; // 10,000,000ìœ¼ë¡œ ë‚˜ëˆ„ê¸°

            const location = new naver.maps.LatLng(latitude, longitude); // ìœ„ë„, ê²½ë„ ìˆœì„œ

            // ê¸°ì¡´ ë§ˆì»¤ ì œê±°
            markers.forEach(marker => {
                marker.setMap(null); // ì§€ë„ì—ì„œ ë§ˆì»¤ ì œê±°
            });
            markers = []; // ë§ˆì»¤ ë°°ì—´ ì´ˆê¸°í™”

            // ìƒˆë¡œìš´ ë§ˆì»¤ ì¶”ê°€
            const marker = new naver.maps.Marker({
                position: location,
                map: map,
                title: item.title
            });

            markers.push(marker); // ìƒˆë¡œìš´ ë§ˆì»¤ ë°°ì—´ì— ì¶”ê°€

            // ì§€ë„ ì´ë™
            map.setCenter(location);
            map.setZoom(16); // ì ì ˆí•œ ì¤Œ ë ˆë²¨ë¡œ ì„¤ì •
        }


        document.addEventListener('DOMContentLoaded', initMap);
    </script>
</body>

</html>