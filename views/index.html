<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title><%= title %></title>
    <link rel="stylesheet" href="/css/Home.css">
    <link rel="stylesheet" href="/css/Map.css">
    <script type="text/javascript" src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=2j5bpft4t3&submodules=geocoder"></script>
    <script src="/js/Home.js" defer></script>
    <script src="/js/Map.js" defer></script>
</head>

<body>
    <div id="content">
        <h1>D U X</h1>
        <div id="login-signup-form" class="form-container">
            <h2>로그인</h2>
            <input type="text" id="login-username" placeholder="아이디">
            <input type="password" id="login-password" placeholder="비밀번호">
            <div id="signup-extra-fields" style="display: none;">
                <input type="password" id="signup-confirm-password" placeholder="비밀번호 확인">
            </div>
            <div class="button-container">
                <button id="login-button">로그인</button>
                <button id="toggle-signup-button">회원가입</button>
            </div>
        </div>
    </div>

    <button class="toggle-button" id="toggleButton" onclick="toggleSidebar()">☰</button>

    <div class="sidebar" id="sidebar" style="display: none;">
        <button class="close-button" onclick="toggleSidebar()">×</button>
        <h2>기능</h2>
        <div id="functionContainer">
            <ul>
                <li onclick="showTravelInfo()">여행 정보 등록</li>
                <li onclick="showUserInfo()">사용자 정보</li>
            </ul>
        </div>
        <div class="search-container" id="searchContainer" style="display: none;">
            <button onclick="goBack()" style="margin-bottom: 10px;">뒤로가기</button>
            <input type="text" id="searchInput" placeholder="검색어를 입력하세요...">
            <button onclick="searchLocations()">검색</button>
            <div id="searchResults" class="results-container"></div>
        </div>
        <button class="logout-button" onclick="logout()" style="margin-top: auto;">🚪 로그아웃</button>
    </div>

    <div id="map" style="width:100%;height:100%;"></div>

    <div class="chat-icon" id="chatIcon" onclick="toggleChatBox()">💬</div>

    <div class="chat-box" id="chatBox">
        <div class="chat-box-header">
            Chat
            <button onclick="toggleChatBox()" style="background: none; border: none; color: white; font-size: 20px;">×</button>
        </div>
        <div class="chat-box-content" id="chatContent"></div>
        <div class="chat-box-footer">
            <input type="text" id="chatInput" placeholder="Type a message...">
            <button onclick="sendMessage()">Send</button>
        </div>
    </div>

    <script>
        let map;
        let markers = [];

        function initMap() {
            map = new naver.maps.Map('map', {
                center: new naver.maps.LatLng(37.3595704, 127.105399),
                zoom: 10
            });
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const toggleButton = document.getElementById('toggleButton');

            if (sidebar.style.display === "none") {
                sidebar.style.display = "block";
                setTimeout(() => {
                    sidebar.classList.add('active');
                }, 10);
                toggleButton.classList.add('hidden');
            } else {
                sidebar.classList.remove('active');
                setTimeout(() => {
                    sidebar.style.display = "none";
                }, 300);
                toggleButton.classList.remove('hidden');
            }
        }

        function showTravelInfo() {
            document.getElementById('functionContainer').style.display = 'none';
            document.getElementById('searchContainer').style.display = 'block';
        }

        function showUserInfo() {
            const userInfoBox = document.getElementById('userInfoBox');
            const userInfo = document.getElementById('userInfo');

            const username = "사용자 아이디"; // 실제 데이터로 대체
            const password = "비밀번호"; // 실제 데이터로 대체

            userInfo.textContent = `아이디: ${username}, 비밀번호: ${password}`;
            userInfoBox.style.display = "block"; // 사용자 정보 박스 보이기
        }

        function goBack() {
            document.getElementById('searchContainer').style.display = 'none';
            document.getElementById('functionContainer').style.display = 'block';
        }

        function logout() {
            window.location.href = '/'; // 초기 화면으로 돌아가기
        }

        function toggleChatBox() {
            const chatBox = document.getElementById('chatBox');
            const chatIcon = document.getElementById('chatIcon');

            if (chatBox.style.display === "none") {
                chatBox.style.display = "flex";
                chatIcon.style.display = "none";
            } else {
                chatBox.style.display = "none";
                chatIcon.style.display = "flex";
            }
        }

        function sendMessage() {
            const chatInput = document.getElementById('chatInput');
            const chatContent = document.getElementById('chatContent');
            const message = chatInput.value;

            if (message.trim() !== "") {
                const newMessage = document.createElement('div');
                newMessage.textContent = message;
                chatContent.appendChild(newMessage);
                chatInput.value = "";
            }
        }

        async function fetchNaverData(query) {
            console.log(`Searching for: ${query}`);
            try {
                const response = await fetch(`/search?query=${encodeURIComponent(query)}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                return data;
            } catch (error) {
                console.error("Error fetching data:", error);
            }
        }

        async function searchLocations() {
            const query = document.getElementById('searchInput').value;
            const results = await fetchNaverData(query);

            const resultsContainer = document.getElementById('searchResults');
            resultsContainer.innerHTML = '';

            if (results.items) {
                results.items.forEach(item => {
                    const resultDiv = document.createElement('div');
                    resultDiv.innerHTML = `
                        <strong>${item.title}</strong><br>
                        <span>${item.description || ''}</span><br>
                        <span>${item.address || ''}</span><br>
                        <button onclick="goToLocation(${item.mapx}, ${item.mapy})">위치로 가기</button>
                    `;
                    resultsContainer.appendChild(resultDiv);
                });
            }
        }

        function goToLocation(mapx, mapy) {
            const longitude = parseFloat(mapx) / 10000000;
            const latitude = parseFloat(mapy) / 10000000;

            const location = new naver.maps.LatLng(latitude, longitude);

            markers.forEach(marker => {
                marker.setMap(null);
            });
            markers = [];

            const marker = new naver.maps.Marker({
                position: location,
                map: map,
                title: "선택한 위치"
            });

            markers.push(marker);
            map.setCenter(location);
            map.setZoom(16);
        }

        document.addEventListener('DOMContentLoaded', initMap);
    </script>
</body>

</html>
